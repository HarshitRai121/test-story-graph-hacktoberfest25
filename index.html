<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Once Upon a Commit â€” The Constellation</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" />
<script src="https://unpkg.com/vis-network/dist/vis-network.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/showdown@1.9.1/dist/showdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<style>
:root{
--bg: #0b1020;
--panel: #0f1724;
--muted: #9aa4b2;
--accent: #ffb86b;
--star: #ffd7a8;
--glass: rgba(255,255,255,0.04);
}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:var(--bg);color:#e6eef8;-webkit-font-smoothing:antialiased;}
/* New Layout */
#app{
display: flex;
height: 100vh;
width: 100vw;
flex-direction: column;
position: relative;
}
#main-container {
display: flex;
flex: 1;
width: 100%;
position: relative;
}
#canvas-wrap{position:absolute;inset:0;z-index:0;overflow:hidden}
canvas#starfield{width:100%;height:100%;display:block}
/* Left Panel & Mobile Menu */
#mobile-menu-toggle {
display: none;
position: absolute;
top: 16px;
left: 16px;
z-index: 100;
background: var(--glass);
border: 1px solid rgba(255,255,255,0.06);
color: var(--star);
padding: 8px 12px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
}
.sidebar-panel{
position: absolute;
top: 0;
bottom: 0;
left: 0;
width: 320px;
max-width: 85vw;
z-index: 50;
display: flex;
flex-direction: column;
background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.012));
box-shadow: 0 6px 30px rgba(0,0,0,0.6);
backdrop-filter: blur(6px);
border-right: 1px solid rgba(255,255,255,0.03);
border-radius: 10px;
transform: translateX(-104%);
transition: transform .38s ease;
}
.sidebar-panel.open { transform: translateX(0); }
.panel-header{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;gap:10px}
.panel-title{font-family:'Cormorant Garamond', serif;font-size:18px;color:var(--accent)}
.panel-body{overflow:auto;padding:12px;flex:1}
.panel-body-group { margin-bottom: 20px; }
.panel-body-group h3 {
font-size: 14px;
color: var(--muted);
border-bottom: 1px solid rgba(255,255,255,0.03);
padding-bottom: 8px;
margin: 0 0 12px 0;
}
.panel-body-group:last-child { margin-bottom: 0; }
/* Limit and scroll Contributors list */
#contributorsList {
  max-height: 250px;
  overflow-y: auto;
  padding-right: 4px;
}
/* Limit and scroll Features list */
.panel-body-group:nth-of-type(3) {
  max-height: 200px;
  overflow-y: auto;
  padding-right: 4px;
}
/* Custom scrollbar styling */
#contributorsList::-webkit-scrollbar,
.panel-body-group:nth-of-type(3)::-webkit-scrollbar { width: 6px; }
#contributorsList::-webkit-scrollbar-track,
.panel-body-group:nth-of-type(3)::-webkit-scrollbar-track { background: transparent; }
#contributorsList::-webkit-scrollbar-thumb,
.panel-body-group:nth-of-type(3)::-webkit-scrollbar-thumb {
  background-color: rgba(255,255,255,0.15);
  border-radius: 999px;
}
#contributorsList::-webkit-scrollbar-thumb:hover,
.panel-body-group:nth-of-type(3)::-webkit-scrollbar-thumb:hover {
  background-color: rgba(255,255,255,0.25);
}
/* Contributors list */
.contributor-item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;margin-bottom:8px;cursor:pointer}
.contributor-item:hover{background:rgba(255,255,255,0.02)}
.contributor-item img{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid rgba(255,255,255,0.06)}
.contributor-name{font-weight:600;color:#fff}
/* Features */
.feature{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:8px;margin-bottom:10px;background:var(--glass);border:1px solid rgba(255,255,255,0.02)}
.feature button{background:none;border:1px solid rgba(255,255,255,0.06);padding:6px 10px;border-radius:8px;color:var(--star);cursor:pointer}
/* Network container */
#network-wrap{
flex: 1;
position: relative;
overflow: hidden;
height: 100%;
max-height: 100vh;
}
#network{ width: 100%; height: 100%; max-height: 100%; }
/* Reading panel */
#reading-panel{
position: absolute;
right: 0;
bottom: 0;
top: 0;
width: min(720px, 92vw);
max-width: 100%;
background: linear-gradient(180deg, rgba(20,22,30,0.96), rgba(8,10,15,0.98));
z-index: 60;
transform: translateX(104%);
transition: transform .38s ease;
border-left: 1px solid rgba(255,255,255,0.03);
display: flex;
flex-direction: column;
}
#reading-panel.open{transform:translateX(0)}
.reading-header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid rgba(255,255,255,0.03)}
.reading-title{font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--accent)}
.reading-body{overflow:auto;padding:20px;flex:1}
.reading-meta{color:var(--muted);font-size:13px;margin-top:6px}
.close-reading{background:none;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:var(--star);cursor:pointer}
/* New responsive rules */
@media (max-width: 900px) {
#app { flex-direction: column; }
.sidebar-panel { top: 0; left: 0; width: 85%; transform: translateX(-100%); transition: transform 0.38s ease-out; }
.sidebar-panel.open { transform: translateX(0); }
#mobile-menu-toggle { display: block; }
#reading-panel { width: 100%; height: 100%; top: 0; left: 0; right: 0; bottom: 0; transform: translateX(100%); transition: transform 0.38s ease-out; }
#reading-panel.open { transform: translateX(0); }
.close-reading { display: none; }
.close-reading-mobile {
display: block !important;
position: absolute;
top: 16px;
right: 16px;
z-index: 100;
background: var(--glass);
border: 1px solid rgba(255,255,255,0.06);
color: var(--star);
padding: 8px 12px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
}
}
@media (min-width: 901px) {
#app { flex-direction: row; }
.sidebar-panel { position: relative; width: 320px; max-width: none; transform: translateX(0); border-right: 1px solid rgba(255,255,255,0.03); border-radius: 0; box-shadow: none; }
#left-panel-body, #right-panel-body { display: block; }
}
/* star legend & logo */
.legend, .logo { display: none; }
@media (min-width: 901px) {
.legend, .logo { display: block; position: absolute; z-index: 55; }
.legend{bottom:18px;left:50%;transform:translateX(-50%);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px 16px;border-radius:999px;font-size:13px;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
.logo{top:16px;left:50%;transform:translateX(-50%);font-family:'Cormorant Garamond',serif;color:var(--accent);font-size:18px;letter-spacing:0.6px}
}
.cta-small{font-size:12px;color:var(--muted);margin-top:6px}
/* small card for node info */
.node-card{background:rgba(0,0,0,0.45);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);max-width:300px;color:#fff}
.node-card h4{margin:0 0 6px 0;font-family:'Cormorant Garamond';color:var(--accent)}
.node-card p{margin:0;font-size:13px;color:var(--muted)}
/* ðŸŒŒ glowing pulse effect for first node */
.glow-node {
  filter: drop-shadow(0 0 10px rgba(170,130,255,0.8))
          drop-shadow(0 0 24px rgba(120,80,200,0.7));
  animation: pulseGlow 3s ease-in-out infinite;
}
@keyframes pulseGlow {
  0%   { filter: drop-shadow(0 0 6px rgba(170,130,255,0.6))
                  drop-shadow(0 0 14px rgba(120,80,200,0.5)); }
  50%  { filter: drop-shadow(0 0 16px rgba(200,160,255,1))
                  drop-shadow(0 0 32px rgba(150,100,220,0.9)); }
  100% { filter: drop-shadow(0 0 6px rgba(170,130,255,0.6))
                  drop-shadow(0 0 14px rgba(120,80,200,0.5)); }
}
</style>
</head>
<body>
<div id="app">
<div id="canvas-wrap" aria-hidden="true"><canvas id="starfield"></canvas></div>
<button id="mobile-menu-toggle">Menu</button>
<aside class="sidebar-panel" id="sidebarPanel">
<div class="panel-header">
<div class="panel-title">Constellation</div>
<button class="close-reading" id="closeSidebar" style="margin-left: auto;">Close</button>
</div>
<div class="panel-body">
<div class="panel-body-group">
  <h3>Quick Index</h3>
  <input type="text" id="quickIndexSearch" placeholder="Search chapters..."
    style="margin-bottom:8px;padding:6px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:var(--glass);color:#fff;width:100%;box-sizing:border-box;">
  <div id="quickIndex" style="display:flex;flex-direction:column;gap:8px"></div>
</div>
<div class="panel-body-group">
<h3>Contributors</h3>
<div style="margin-bottom:8px;color:var(--muted);font-size:13px">Tap a star to read. Click a contributor to focus their nodes.</div>
<div id="contributorsList" style="display:grid;grid-template-columns:1fr;gap:6px"></div>
</div>
<div class="panel-body-group">
<h3>Features</h3>
<div class="feature"><div><div style="font-weight:700">Reading Mode</div><div style="font-size:13px;color:var(--muted)">Open chapters in immersive reading panel</div></div><div><button id="btnReadingMode">Open</button></div></div>
<div class="feature"><div><div style="font-weight:700">Download Chapter</div><div style="font-size:13px;color:var(--muted)">Export the open chapter as PDF</div></div><div><button id="btnDownload">Download</button></div></div>
<div class="feature"><div><div style="font-weight:700">Theme</div><div style="font-size:13px;color:var(--muted)">Toggle dark / soft mode</div></div><div><button id="btnTheme">ðŸŒ™</button></div></div>
</div>
</div>
</aside>
<div id="main-container">
<div id="network-wrap"><div id="network"></div></div>
<aside id="reading-panel" aria-hidden="true">
<div class="reading-header">
<div><div class="reading-title" id="readingTitle">Chapter</div><div class="reading-meta" id="readingMeta">by unknown</div></div>
<div style="display:flex;gap:8px;align-items:center">
<button class="close-reading" id="downloadCurrent">Save PDF</button>
<button class="close-reading" id="closeReading">Close</button>
<button class="close-reading-mobile" id="closeReadingMobile" style="display: none;">Close</button>
</div>
</div>
<div class="reading-body" id="readingBody"></div>
</aside>
</div>
<div class="logo">Once Upon a Commit â€” The Constellation</div>
<div class="legend">Tap a star â†’ open chapter Â· Click contributor â†’ highlight</div>
</div>
<script>
(function(){
// â€¦ unchanged code above â€¦

// ------- network rendering -------
function buildNetwork(chapters){
  const nodes = [], edges = [], degreeCount = {};
  chapters.forEach(c=>{
    const id = c.filename;
    const title = c.metadata.title || id;
    const author = c.metadata.author || 'unknown';
    degreeCount[id] = degreeCount[id] || 0;

    // ðŸŒŒ Central node special treatment
    if(id === "chapter01.md"){
      nodes.push({
        id, label: title, title, author,
        size: 42,
        shape: "dot",
        color: { background:'#d5c4ff', border:'#a07cff', highlight:{background:'#efe6ff',border:'#a07cff'} },
        fixed: { x:true, y:true }, x:0, y:0
      });
    } else {
      nodes.push({ id, label: title, title, author, value: 10 });
    }

    if(c.metadata.parent){
      edges.push({ from:c.metadata.parent, to:id });
      degreeCount[c.metadata.parent] = (degreeCount[c.metadata.parent]||0)+1;
      degreeCount[id] = (degreeCount[id]||0)+1;
    }
  });

  nodes.forEach(n=>{
    if(n.id !== "chapter01.md"){
      const deg = degreeCount[n.id]||0;
      const isMobile = window.innerWidth < 900;
      n.size = Math.min(8+deg*6, isMobile?18:28);
      n.color = { background:`rgba(255,200,120,0.95)`, border:'#ffb86b', highlight:{background:'#fff1e6'} };
      n.shape = 'dot';
    }
  });

  nodesDS = new vis.DataSet(nodes);
  edgesDS = new vis.DataSet(edges);
  data = { nodes:nodesDS, edges:edgesDS };

  const options = {
    autoResize:true,
    interaction:{ hover:true, tooltipDelay:100, navigationButtons:true, multiselect:false },
    nodes:{ font:{face:'Inter',size:14,color:'#08162A'}, scaling:{min:8,max:32} },
    edges:{ color:'rgba(255,255,255,0.06)', smooth:{enabled:true,type:'dynamic'} },
    physics:{ stabilization:false, barnesHut:{gravitationalConstant:-24000, springLength:120, springConstant:0.001} },
    layout:{ improvedLayout:true }
  };

  network = new vis.Network(networkEl, data, options);
  network.on('click', params => { if(params.nodes && params.nodes.length>0){ openNode(params.nodes[0]); } });

  // ðŸŒŒ apply glowing effect to first node after draw
  network.once("afterDrawing", ()=>{
    const canvasEl = document.querySelector(".vis-network canvas");
    if(canvasEl){ canvasEl.classList.add("glow-node"); }
  });
}

// ------- starfield canvas background -------
(function starfield(){
  const canvas=document.getElementById('starfield');
  const ctx=canvas.getContext('2d');
  let w=0,h=0,DPR=window.devicePixelRatio||1;
  function resize(){ w=canvas.width=Math.floor(window.innerWidth*DPR); h=canvas.height=Math.floor(window.innerHeight*DPR); canvas.style.width=window.innerWidth+'px'; canvas.style.height=window.innerHeight+'px'; ctx.scale(DPR,DPR); initStars(); }
  window.addEventListener('resize',resize);
  let stars=[];
  function initStars(){ stars=[]; const count=Math.floor((window.innerWidth+window.innerHeight)/8); for(let i=0;i<count;i++){ stars.push({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,r:(Math.random()*1.8)+0.4,alpha:Math.random()*0.9+0.1,twinkle:Math.random()*0.02+0.005,vx:(Math.random()-0.5)*0.02,vy:(Math.random()-0.5)*0.02}); } }
  let mouseX=window.innerWidth/2, mouseY=window.innerHeight/2;
  window.addEventListener('mousemove', e=>{mouseX=e.clientX; mouseY=e.clientY;});
  window.addEventListener('touchmove', e=>{if(e.touches&&e.touches[0]){mouseX=e.touches[0].clientX; mouseY=e.touches[0].clientY}}, {passive:true});
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // ðŸŒŒ central radial nebula
    const nebula=ctx.createRadialGradient(window.innerWidth/2,window.innerHeight/2,0, window.innerWidth/2,window.innerHeight/2,Math.min(window.innerWidth,window.innerHeight)/2);
    nebula.addColorStop(0,"rgba(120,80,200,0.35)");
    nebula.addColorStop(0.4,"rgba(80,40,120,0.25)");
    nebula.addColorStop(1,"rgba(10,14,28,0.9)");
    ctx.fillStyle=nebula; ctx.fillRect(0,0,window.innerWidth,window.innerHeight);
    stars.forEach(s=>{
      const dx=(mouseX-window.innerWidth/2)/window.innerWidth;
      const dy=(mouseY-window.innerHeight/2)/window.innerHeight;
      const px=s.x+dx*20*(s.r); const py=s.y+dy*20*(s.r);
      s.alpha+=(Math.random()*0.02-0.01)*s.twinkle;
      if(s.alpha<0.15) s.alpha=0.15; if(s.alpha>1) s.alpha=1;
      ctx.beginPath();
      ctx.fillStyle=`rgba(255,${220-s.r*40},${160-s.r*20},${s.alpha})`;
      ctx.arc(px,py,s.r,0,Math.PI*2);
      ctx.fill();
    });
    requestAnimationFrame(draw);
  }
  resize(); draw();
})();
loadStories();
})();
</script>
</body>
</html>
