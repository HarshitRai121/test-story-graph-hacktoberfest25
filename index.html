<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Once Upon a Commit â€” The Constellation</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

  <!-- Vis Network -->
  <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/vis-network/dist/vis-network.min.js"></script>

  <!-- Showdown (markdown) -->
  <script src="https://cdn.jsdelivr.net/npm/showdown@1.9.1/dist/showdown.min.js"></script>

  <!-- html2pdf for PDF export (client-side) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <meta name="theme-color" content="#0b1020">

  <style>
    :root{
      --bg: #0b1020;
      --panel: rgba(15,23,36,0.6);
      --muted: #9aa4b2;
      --accent: #ffb86b;
      --star: #ffd7a8;
      --glass: rgba(255,255,255,0.03);
      --card-radius: 14px;
      --max-width: 1400px;
      --nav-height: 64px;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;color:#e6eef8;background:var(--bg);-webkit-font-smoothing:antialiased}
    *{box-sizing:border-box}
    #app{position:relative;min-height:100vh;display:flex;flex-direction:column;align-items:stretch;overflow:hidden}

    /* canvas background */
    #canvas-wrap{position:fixed;inset:0;z-index:0;overflow:hidden}
    canvas#starfield{width:100%;height:100%;display:block}

    /* top logo */
    .topbar{position:fixed;left:0;right:0;top:12px;z-index:70;display:flex;align-items:center;justify-content:center;pointer-events:none}
    .logo{pointer-events:auto;display:inline-flex;align-items:center;gap:12px;padding:8px 14px;border-radius:999px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.03);font-family:'Cormorant Garamond',serif;color:var(--accent);font-size:16px;letter-spacing:0.4px}

    /* container for network */
    .main-wrap{position:relative;z-index:10;flex:1;display:block;width:100%;max-width:var(--max-width);margin:0 auto}
    #network-wrap{position:fixed;left:0;right:0;top:0;bottom:0;z-index:10;display:flex;align-items:stretch;justify-content:center;padding:0 12px}
    #network{width:100%;height:100%}

    /* Panels (desktop) */
    .panel{position:fixed;top:12px;bottom:12px;width:320px;max-width:34vw;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 10px 40px rgba(0,0,0,0.6);backdrop-filter:blur(8px);border-radius:var(--card-radius);border:1px solid rgba(255,255,255,0.03);z-index:60;display:flex;flex-direction:column;overflow:hidden;padding:0}
    .left-panel{left:12px}
    .right-panel{right:12px}
    .panel-header{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;gap:10px}
    .panel-title{font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--accent)}
    .panel-body{overflow:auto;padding:12px;flex:1}

    .contributor-item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;margin-bottom:8px;cursor:pointer}
    .contributor-item:hover{background:rgba(255,255,255,0.02)}
    .contributor-item img{width:48px;height:48px;border-radius:50%;object-fit:cover;border:1px solid rgba(255,255,255,0.06)}
    .contributor-name{font-weight:700;color:#fff}

    .feature{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;margin-bottom:10px;background:var(--glass);border:1px solid rgba(255,255,255,0.02)}
    .feature button{background:none;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:var(--star);cursor:pointer;font-weight:600}

    /* reading panel - desktop slide in from right */
    #reading-panel{position:fixed;right:12px;top:12px;bottom:12px;width:min(720px,90vw);max-width:46vw;background:linear-gradient(180deg, rgba(20,22,30,0.98), rgba(8,10,15,0.99));z-index:70;border-radius:var(--card-radius);box-shadow:0 20px 60px rgba(0,0,0,0.7);transform:translateX(120%);transition:transform .38s ease}
    #reading-panel.open{transform:translateX(0)}
    .reading-header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .reading-title{font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--accent)}
    .reading-body{overflow:auto;padding:20px;flex:1;color:#eaf2ff;font-size:15px;line-height:1.6}
    .reading-meta{color:var(--muted);font-size:13px;margin-top:6px}
    .close-reading{background:none;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:var(--star);cursor:pointer;font-weight:600}

    /* small node info card */
    .node-card{position:absolute;left:16px;top:80px;background:rgba(0,0,0,0.55);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);color:#fff;z-index:65;display:none}
    .node-card h4{margin:0 0 6px 0;font-family:'Cormorant Garamond';color:var(--accent)}
    .node-card p{margin:0;font-size:13px;color:var(--muted)}

    /* legend */
    .legend{position:fixed;bottom:84px;left:50%;transform:translateX(-50%);z-index:55;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:8px 14px;border-radius:999px;font-size:13px;color:var(--muted);border:1px solid rgba(255,255,255,0.03);display:flex;gap:8px;align-items:center}

    /* bottom navigation (mobile) */
    .bottom-nav{position:fixed;left:0;right:0;bottom:0;height:var(--nav-height);z-index:80;background:linear-gradient(180deg, rgba(8,10,14,0.86), rgba(2,4,8,0.98));display:flex;align-items:center;justify-content:space-around;padding:0 8px;border-top:1px solid rgba(255,255,255,0.03);backdrop-filter:blur(6px)}
    .nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px 6px;border-radius:12px;color:var(--muted);font-size:12px;cursor:pointer;user-select:none}
    .nav-btn.active{color:var(--accent)}
    .nav-btn svg{width:22px;height:22px;margin-bottom:4px;opacity:0.95}

    /* mobile modals / bottom sheet */
    .modal{position:fixed;left:12px;right:12px;background:linear-gradient(180deg, rgba(10,12,16,0.98), rgba(6,8,10,0.995));z-index:90;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.7);max-height:86vh;display:flex;flex-direction:column;transform:translateY(120%);transition:transform .32s cubic-bezier(.2,.9,.2,1)}
    .modal.open{transform:translateY(6vh)}
    .modal .modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .modal .modal-body{overflow:auto;padding:12px;flex:1}

    /* make contributors list denser on mobile */
    .contributor-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}

    /* media queries - mobile-first */
    @media (min-width:900px){
      .bottom-nav{display:none}
      .modal{display:none}
      .panel{display:flex}
      .left-panel{display:flex}
      .right-panel{display:flex}
      #reading-panel{display:flex}
      .legend{bottom:18px}
    }
    @media (max-width:899px){
      .panel{display:none}
      #reading-panel{display:none}
      .node-card{left:8px;top:64px}
      .legend{bottom:86px}
      .logo{font-size:15px}
      .topbar{top:8px}
    }

    /* small niceties */
    button:focus{outline:2px solid rgba(255,184,107,0.18);outline-offset:2px}
    a,button{font-family:inherit}
    hr.sep{border:none;border-top:1px solid rgba(255,255,255,0.03);margin:10px 0}
  </style>
</head>
<body>
  <div id="app">
    <!-- canvas background -->
    <div id="canvas-wrap" aria-hidden="true">
      <canvas id="starfield"></canvas>
    </div>

    <!-- top logo -->
    <div class="topbar"><div class="logo">Once Upon a Commit â€” The Constellation</div></div>

    <!-- desktop left panel (contributors) -->
    <aside class="panel left-panel" id="leftPanel" role="complementary" aria-label="Contributors panel">
      <div class="panel-header"><div class="panel-title">Constellation</div><div style="margin-left:auto;font-size:13px;color:var(--muted)">Hacktoberfest 2025</div></div>
      <div class="panel-body" id="contributorsBody">
        <div style="margin-bottom:10px;color:var(--muted);font-size:13px">Tap a star on the map to read. Click a contributor to highlight their nodes.</div>
        <div id="contributorsList" style="display:grid;grid-template-columns:1fr;gap:8px"></div>
      </div>
    </aside>

    <!-- desktop right panel (features) -->
    <aside class="panel right-panel" id="rightPanel" role="navigation" aria-label="Features panel">
      <div class="panel-header"><div class="panel-title">Features</div></div>
      <div class="panel-body" id="featuresBody">
        <div class="feature">
          <div><div style="font-weight:700">Reading Mode</div><div style="font-size:13px;color:var(--muted)">Open chapters in immersive reading panel</div></div>
          <div><button id="btnReadingMode" aria-label="Open reading mode">Open</button></div>
        </div>

        <div class="feature">
          <div><div style="font-weight:700">Download Chapter</div><div style="font-size:13px;color:var(--muted)">Export the open chapter as PDF</div></div>
          <div><button id="btnDownload" aria-label="Download open chapter">Download</button></div>
        </div>

        <div class="feature">
          <div><div style="font-weight:700">Theme</div><div style="font-size:13px;color:var(--muted)">Toggle dark / light</div></div>
          <div><button id="btnTheme" aria-label="Toggle theme">ðŸŒ™</button></div>
        </div>

        <hr class="sep">

        <div style="margin-bottom:8px;color:var(--muted);font-size:13px">Quick Index (tap to jump)</div>
        <div id="quickIndex" style="display:flex;flex-direction:column;gap:8px"></div>

        <hr class="sep">
        <div style="color:var(--muted);font-size:13px">Legend: Stars are nodes â€” brighter ones have more branches</div>
      </div>
    </aside>

    <!-- main network -->
    <main class="main-wrap" role="main">
      <div id="network-wrap"><div id="network" role="application" aria-label="Story graph"></div></div>
    </main>

    <!-- desktop reading panel -->
    <aside id="reading-panel" aria-hidden="true">
      <div class="reading-header">
        <div>
          <div class="reading-title" id="readingTitle">Chapter</div>
          <div class="reading-meta" id="readingMeta">by unknown</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="close-reading" id="downloadCurrent" aria-label="Save PDF">Save PDF</button>
          <button class="close-reading" id="closeReading" aria-label="Close reading">Close</button>
        </div>
      </div>
      <div class="reading-body" id="readingBody" tabindex="0"></div>
    </aside>

    <!-- small node hover card -->
    <div class="node-card" id="nodeCard" aria-hidden="true"><h4 id="nodeCardTitle">Title</h4><p id="nodeCardSub">meta</p></div>

    <!-- legend -->
    <div class="legend">Tap a star â†’ open chapter Â· Click contributor â†’ highlight Â· <span style="color:var(--muted);font-size:12px;margin-left:6px">Mobile friendly â€¢ Live updates</span></div>

    <!-- bottom nav for mobile -->
    <nav class="bottom-nav" role="navigation" aria-label="Primary">
      <div class="nav-btn" id="navGraph" title="Graph">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="6" cy="12" r="2"></circle><circle cx="12" cy="6" r="2"></circle><circle cx="18" cy="12" r="2"></circle><path d="M7.6 11.2L10.4 7.8"></path><path d="M13.6 8.2L16.4 11.8"></path></svg>
        <span>Graph</span>
      </div>
      <div class="nav-btn" id="navContrib" title="Contributors">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M16 11c1.657 0 3 1.567 3 3.5S17.657 18 16 18H8c-1.657 0-3-1.567-3-3.5S6.343 11 8 11h8z"></path><circle cx="12" cy="7" r="3"></circle></svg>
        <span>People</span>
      </div>
      <div class="nav-btn" id="navFeatures" title="Features">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 8v4l3 3"></path><circle cx="12" cy="12" r="10"></circle></svg>
        <span>Features</span>
      </div>
      <div class="nav-btn" id="navReading" title="Reading">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 7v10a2 2 0 0 0 2 2h14"></path><path d="M7 7v10"></path><path d="M17 7v10"></path></svg>
        <span>Read</span>
      </div>
    </nav>

    <!-- mobile modals -->
    <div class="modal" id="modalContrib" aria-hidden="true" role="dialog" aria-label="Contributors">
      <div class="modal-header"><div class="panel-title">Contributors</div><button class="close-reading" id="closeModalContrib" aria-label="Close contributors">Close</button></div>
      <div class="modal-body" id="modalContribBody"></div>
    </div>

    <div class="modal" id="modalFeatures" aria-hidden="true" role="dialog" aria-label="Features">
      <div class="modal-header"><div class="panel-title">Features</div><button class="close-reading" id="closeModalFeatures" aria-label="Close features">Close</button></div>
      <div class="modal-body" id="modalFeaturesBody"></div>
    </div>

    <div class="modal" id="modalReading" aria-hidden="true" role="dialog" aria-label="Reading">
      <div class="modal-header"><div><div class="reading-title" id="modalReadingTitle">Chapter</div><div class="reading-meta" id="modalReadingMeta">by unknown</div></div><button class="close-reading" id="closeModalReading" aria-label="Close reading modal">Close</button></div>
      <div class="modal-body" id="modalReadingBody" tabindex="0"></div>
    </div>

  </div>

  <script>
  /************************************************************************
   * Redesigned mobile-first index.html
   * - Fetches /api/stories
   * - Renders vis-network as a star map
   * - Mobile bottom navigation + modal sheets
   * - Desktop side panels + slide-in reading drawer
   * - Accessible controls & PDF export
   ************************************************************************/
  (function(){
    // DOM refs
    const networkEl = document.getElementById('network');
    const readingPanel = document.getElementById('reading-panel');
    const readingTitle = document.getElementById('readingTitle');
    const readingMeta = document.getElementById('readingMeta');
    const readingBody = document.getElementById('readingBody');
    const closeReading = document.getElementById('closeReading');
    const btnReadingMode = document.getElementById('btnReadingMode');
    const btnDownload = document.getElementById('btnDownload');
    const btnTheme = document.getElementById('btnTheme');
    const downloadCurrent = document.getElementById('downloadCurrent');
    const quickIndex = document.getElementById('quickIndex');
    const contributorsList = document.getElementById('contributorsList');
    const contributorsBody = document.getElementById('contributorsBody');

    // mobile nav and modals
    const navGraph = document.getElementById('navGraph');
    const navContrib = document.getElementById('navContrib');
    const navFeatures = document.getElementById('navFeatures');
    const navReading = document.getElementById('navReading');
    const modalContrib = document.getElementById('modalContrib');
    const modalFeatures = document.getElementById('modalFeatures');
    const modalReading = document.getElementById('modalReading');
    const modalContribBody = document.getElementById('modalContribBody');
    const modalFeaturesBody = document.getElementById('modalFeaturesBody');
    const modalReadingBody = document.getElementById('modalReadingBody');
    const modalReadingTitle = document.getElementById('modalReadingTitle');
    const modalReadingMeta = document.getElementById('modalReadingMeta');

    // node hover card
    const nodeCard = document.getElementById('nodeCard');
    const nodeCardTitle = document.getElementById('nodeCardTitle');
    const nodeCardSub = document.getElementById('nodeCardSub');

    let chaptersMap = {}; // filename -> { filename, metadata, content }
    let contributors = []; // array
    let network, data, nodesDS, edgesDS;
    let currentOpen = null;
    const converter = new showdown.Converter({tables:true, simplifiedAutoLink:true, strikethrough:true, tasklists:true});

    // small helpers
    function el(tag, props={}, ...children){
      const node = document.createElement(tag);
      Object.entries(props||{}).forEach(([k,v])=>{
        if(k==='class') node.className = v;
        else if(k.startsWith('on') && typeof v === 'function') node[k] = v;
        else node.setAttribute(k, String(v));
      });
      children.forEach(c=> { if(typeof c === 'string') node.appendChild(document.createTextNode(c)); else if(c) node.appendChild(c);});
      return node;
    }

    // ------- fetch data from /api/stories -------
    async function loadStories(){
      try {
        const res = await fetch('/api/stories');
        if(!res.ok) throw new Error('Failed to fetch /api/stories');
        const json = await res.json();
        json.chapters.forEach(c => { chaptersMap[c.filename] = c; });
        contributors = json.contributors || [];
        buildNetwork(json.chapters);
        renderContributors(contributors);
        buildQuickIndex(json.chapters);
        buildModalFeatures(); // populate features for mobile
      } catch(err){
        console.error(err);
        networkEl.innerHTML = `<div style="padding:20px;color:#f8d7da">Failed to load story network. (${err.message})</div>`;
      }
    }

    // ------- quick index (root nodes) -------
    function buildQuickIndex(chapters){
      const tops = chapters.filter(c => !c.metadata.parent || c.metadata.parent.trim()==='').sort((a,b)=> a.filename.localeCompare(b.filename));
      quickIndex.innerHTML = '';
      tops.slice(0,20).forEach(t=>{
        const btn = el('button',{class:'feature', onclick: ()=> openNode(t.filename), style:'justify-content:space-between'});
        btn.innerHTML = `<div style="font-weight:700">${escapeHtml(t.metadata.title||t.filename)}</div><div style="font-size:12px;color:var(--muted)">${escapeHtml(t.metadata.author||'â€”')}</div>`;
        quickIndex.appendChild(btn);
      });
      // also fill mobile modal features quick index
      if(modalFeaturesBody) {
        const section = el('div',{});
        section.appendChild(el('div',{}, el('strong',{}, 'Quick Index')));
        tops.slice(0,20).forEach(t=>{
          const b = el('button',{class:'feature', onclick: ()=> { openNode(t.filename); openReadingModal(); }});
          b.style.justifyContent='space-between';
          b.innerHTML = `<div style="font-weight:700">${escapeHtml(t.metadata.title||t.filename)}</div><div style="font-size:12px;color:var(--muted)">${escapeHtml(t.metadata.author||'â€”')}</div>`;
          section.appendChild(b);
        });
        modalFeaturesBody.appendChild(section);
      }
    }

    // ------- render contributors -------
    function renderContributors(list){
      contributorsList.innerHTML = '';
      modalContribBody.innerHTML = '';
      list.forEach(c=>{
        const elItem = document.createElement('div');
        elItem.className = 'contributor-item';
        elItem.innerHTML = `<img crossorigin="anonymous" src="${c.avatar_url}" alt="${c.login}"><div><div class="contributor-name">${c.login}</div><div style="font-size:12px;color:var(--muted)">nodes: ${c.contributedNodes.length||0}</div></div>`;
        elItem.onclick = ()=> { highlightByAuthor(c.login); if(window.innerWidth < 900){ openModal(modalContrib,false); } };
        contributorsList.appendChild(elItem);

        // mobile grid item:
        const mobileItem = el('div',{class:'contributor-item', onclick: ()=> { highlightByAuthor(c.login); openModal(modalContrib,false); }});
        mobileItem.innerHTML = `<img crossorigin="anonymous" src="${c.avatar_url}" alt="${c.login}" style="width:56px;height:56px"><div><div class="contributor-name">${c.login}</div><div style="font-size:12px;color:var(--muted)">nodes: ${c.contributedNodes.length||0}</div></div>`;
        modalContribBody.appendChild(mobileItem);
      });

      // make contributors grid dense on mobile
      if(modalContribBody){
        modalContribBody.classList.add('contributor-grid');
      }
    }

    // ------- highlight nodes by author -------
    function highlightByAuthor(login){
      const all = nodesDS.get();
      const byAuthor = Object.values(chaptersMap).filter(ch => ch.metadata.author === login).map(ch => ch.filename);

      const updated = all.map(n=>{
        if(byAuthor.includes(n.id)){
          return { id: n.id, color: {background:'#ffe8c8', border:'#ffb86b'}, size: Math.max((n.value||10), 18) };
        } else {
          return { id: n.id, color: {background:'#1f2a44', border:'#2b3b5a'}, size: Math.max((n.value||10), 8) };
        }
      });
      nodesDS.update(updated);
      if(byAuthor.length) network.fit({ nodes: byAuthor, animation: { duration: 600, easingFunction: 'easeInOutQuad' }});
    }

    // ------- open node reading (desktop & mobile) -------
    function openNode(filename){
      const node = chaptersMap[filename];
      if(!node) return;
      currentOpen = filename;
      readingTitle.textContent = node.metadata.title || 'Untitled';
      readingMeta.textContent = `by ${node.metadata.author || 'unknown'} â€¢ ${filename}`;
      readingBody.innerHTML = converter.makeHtml(node.content || '');

      // for mobile: if bottom reading modal is visible, update it too
      modalReadingTitle.textContent = readingTitle.textContent;
      modalReadingMeta.textContent = readingMeta.textContent;
      modalReadingBody.innerHTML = readingBody.innerHTML;
    }

    function openReadingPanel(){
      if(window.innerWidth >= 900) {
        readingPanel.classList.add('open');
        readingPanel.setAttribute('aria-hidden', 'false');
      } else {
        openModal(modalReading, true);
      }
    }

    // ------- close reading panel -------
    closeReading.onclick = ()=>{ readingPanel.classList.remove('open'); readingPanel.setAttribute('aria-hidden','true'); currentOpen = null; }
    document.getElementById('closeModalReading').onclick = ()=> closeModal(modalReading);
    document.getElementById('closeModalContrib').onclick = ()=> closeModal(modalContrib);
    document.getElementById('closeModalFeatures').onclick = ()=> closeModal(modalFeatures);

    // ------- pdf download -------
    btnDownload.onclick = async ()=>{ if(!currentOpen){ alert('Open a chapter to download.'); return; } await exportChapterAsPDF(currentOpen); }
    downloadCurrent.onclick = async ()=>{ if(currentOpen) await exportChapterAsPDF(currentOpen); }

    async function exportChapterAsPDF(filename){
      const node = chaptersMap[filename]; if(!node) return;
      const pdfWrap = document.createElement('div');
      pdfWrap.style.padding = '36px';
      pdfWrap.style.background = '#fff';
      pdfWrap.style.color = '#111';
      pdfWrap.innerHTML = `
        <h1 style="font-family: 'Cormorant Garamond', serif; font-size:28px; color:#111; margin-bottom:6px">${escapeHtml(node.metadata.title||'Untitled')}</h1>
        <div style="font-size:13px;color:#555;margin-bottom:16px">by ${escapeHtml(node.metadata.author||'unknown')}</div>
        <div>${converter.makeHtml(node.content||'')}</div>
        <hr style="margin-top:20px;border:none;border-top:1px solid #eee">
        <div style="font-size:11px;color:#888;margin-top:8px">Once Upon a Commit â€” The Constellation</div>
      `;
      document.body.appendChild(pdfWrap);
      const opt = { margin: 10, filename: `${sanitizeFilename(node.metadata.title||filename)}.pdf`, image:{type:'jpeg',quality:0.95}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}};
      try {
        await html2pdf().set(opt).from(pdfWrap).save();
      } catch(e){ console.error(e); alert('Export failed.'); }
      pdfWrap.remove();
    }

    // ------- network rendering -------
    function buildNetwork(chapters){
      const nodes = [];
      const edges = [];
      const degreeCount = {};

      chapters.forEach(c=>{
        const id = c.filename;
        const title = c.metadata.title || id;
        const author = c.metadata.author || 'unknown';
        degreeCount[id] = degreeCount[id] || 0;
        nodes.push({ id, label: title, title: title, author, value: 10 });
        if(c.metadata.parent){
          edges.push({ from: c.metadata.parent, to: id });
          degreeCount[c.metadata.parent] = (degreeCount[c.metadata.parent]||0) + 1;
          degreeCount[id] = (degreeCount[id]||0) + 1;
        }
      });

      nodes.forEach(n=>{
        const deg = degreeCount[n.id] || 0;
        const size = Math.min(8 + deg*6, 30);
        n.size = size;
        // color scheme - subtle warm glow with alpha
        n.color = { background: `rgba(255,${200 - Math.min(deg*10,120)},${120 - Math.min(deg*6,60)},${0.95})`, border: '#ffb86b', highlight: { background:'#fff1e6' } };
        n.shape = 'dot';
      });

      nodesDS = new vis.DataSet(nodes);
      edgesDS = new vis.DataSet(edges);
      data = { nodes: nodesDS, edges: edgesDS };

      const options = {
        autoResize: true,
        interaction: { hover:true, tooltipDelay:100, navigationButtons:true, multiselect:false, zoomView:true, dragView:true },
        nodes: { font:{face:'Inter', size:14, color:'#08162A'}, scaling:{min:8,max:36} },
        edges: { color: 'rgba(255,255,255,0.06)', smooth: { enabled:true, type:'dynamic' } },
        physics: { stabilization:false, barnesHut:{gravitationalConstant:-24000, springLength:120, springConstant:0.001} },
        layout: { improvedLayout:true }
      };

      network = new vis.Network(networkEl, data, options);

      // click -> open chapter
      network.on('click', params=>{
        if(params.nodes && params.nodes.length>0){
          const id = params.nodes[0];
          openNode(id);
          // open reading mode: desktop slide, mobile bottom sheet
          openReadingPanel();
        }
      });

      // hover node -> show small floating card
      network.on('hoverNode', function(params){
        const node = nodesDS.get(params.node);
        if(!node) return;
        nodeCardTitle.textContent = node.label || node.id;
        nodeCardSub.textContent = `by ${node.author||'unknown'}`;
        nodeCard.style.display = 'block';
      });
      network.on('blurNode', function(){ nodeCard.style.display = 'none'; });

      // move small card with mouse
      network.on('mousemove', function(params){
        if(!nodeCard) return;
        const pos = params.event.center || {x: params.event.pageX, y: params.event.pageY};
        const x = (params.event.pageX || pos.x) - 160;
        const y = (params.event.pageY || pos.y) - 120;
        nodeCard.style.left = Math.max(8, x) + 'px';
        nodeCard.style.top = Math.max(64, y) + 'px';
      });

      // improve touch interactions: pinch/zoom handled by vis; but also provide instructions for mobile
      if(window.innerWidth < 900){
        const hint = el('div',{style:'position:absolute;right:12px;bottom:160px;background:rgba(0,0,0,0.45);padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);z-index:60;color:var(--muted);font-size:13px'}, 'Pinch to zoom â€¢ Drag to pan');
        document.body.appendChild(hint);
        setTimeout(()=> hint.remove(), 5000);
      }
    }

    // ------- small helpers -------
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function sanitizeFilename(s){ return (s||'chapter').replace(/[^a-z0-9_\- ]/gi,'_').trim(); }

    // ------- theme toggle -------
    let dark = true;
    btnTheme.onclick = ()=> {
      dark = !dark;
      if(dark){
        document.documentElement.style.setProperty('--bg','#0b1020');
        btnTheme.textContent = 'ðŸŒ™';
        document.querySelector('meta[name="theme-color"]').setAttribute('content','#0b1020');
      } else {
        document.documentElement.style.setProperty('--bg','#f7f7f7');
        btnTheme.textContent = 'â˜€';
        document.querySelector('meta[name="theme-color"]').setAttribute('content','#f7f7f7');
      }
      document.body.style.background = getComputedStyle(document.documentElement).getPropertyValue('--bg');
    };

    // ------- reading mode desktop/mobile -------
    btnReadingMode.onclick = ()=> {
      if(currentOpen){ openReadingPanel(); return; }
      const ids = nodesDS.getIds();
      if(ids.length) { openNode(ids[0]); openReadingPanel(); }
    };

    // ------- modal utilities (mobile) -------
    function openModal(modalEl, lockBody=true){
      if(!modalEl) return;
      modalEl.classList.add('open');
      modalEl.setAttribute('aria-hidden','false');
      if(lockBody) document.body.style.overflow = 'hidden';
    }
    function closeModal(modalEl){
      if(!modalEl) return;
      modalEl.classList.remove('open');
      modalEl.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
    }

    function openReadingModal(){ openModal(modalReading, true); }

    // bottom nav interactions
    navGraph.onclick = ()=> { // focus graph -> close any modal
      closeModal(modalContrib); closeModal(modalFeatures); closeModal(modalReading);
      setActiveNav(navGraph);
    };
    navContrib.onclick = ()=> { openModal(modalContrib); setActiveNav(navContrib); };
    navFeatures.onclick = ()=> { openModal(modalFeatures); setActiveNav(navFeatures); };
    navReading.onclick = ()=> { if(currentOpen) { openReadingModal(); } else { // open first node to read
      const ids = nodesDS ? nodesDS.getIds() : []; if(ids.length){ openNode(ids[0]); openReadingModal(); } } setActiveNav(navReading); };

    function setActiveNav(el){ [navGraph,navContrib,navFeatures,navReading].forEach(b=>b.classList.remove('active')); if(el) el.classList.add('active'); }

    // keyboard accessibility: Escape closes modals & reading panel
    window.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        if(window.innerWidth >= 900){
          readingPanel.classList.remove('open');
        } else {
          closeModal(modalContrib); closeModal(modalFeatures); closeModal(modalReading);
        }
      }
    });

    // Build mobile features modal content (duplicate of desktop)
    function buildModalFeatures(){
      modalFeaturesBody.innerHTML = '';
      const readingBtn = el('div',{style:'margin-bottom:8px'}, el('button',{class:'feature', onclick: ()=> { btnReadingMode.click(); openModal(modalReading,true); }}, 'Open Reading Mode'));
      const downloadBtn = el('div',{style:'margin-bottom:8px'}, el('button',{class:'feature', onclick: ()=> { btnDownload.click(); }}, 'Download current chapter'));
      modalFeaturesBody.appendChild(readingBtn);
      modalFeaturesBody.appendChild(downloadBtn);

      // theme control
      const themeWrap = el('div',{style:'margin-top:8px'}, el('button',{class:'feature', onclick: ()=> btnTheme.click()}, 'Toggle theme'));
      modalFeaturesBody.appendChild(themeWrap);
    }

    // ------- starfield background (mobile-ready) -------
    (function starfield(){
      const canvas = document.getElementById('starfield');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      let w=0,h=0,DPR=window.devicePixelRatio||1;
      function resize(){ w = canvas.width = Math.floor(window.innerWidth*DPR); h = canvas.height = Math.floor(window.innerHeight*DPR); canvas.style.width = window.innerWidth + 'px'; canvas.style.height = window.innerHeight + 'px'; ctx.setTransform(DPR,0,0,DPR,0,0); initStars(); }
      window.addEventListener('resize', resize);

      let stars=[];
      function initStars(){
        stars = [];
        const count = Math.floor((window.innerWidth + window.innerHeight)/8);
        for(let i=0;i<count;i++){
          stars.push({
            x: Math.random()*window.innerWidth,
            y: Math.random()*window.innerHeight,
            r: (Math.random()*1.8)+0.4,
            alpha: Math.random()*0.9 + 0.1,
            twinkle: Math.random()*0.02+0.005,
            vx: (Math.random()-0.5)*0.02,
            vy: (Math.random()-0.5)*0.02
          });
        }
      }

      let mouseX=window.innerWidth/2, mouseY=window.innerHeight/2;
      window.addEventListener('mousemove', e=>{ mouseX = e.clientX; mouseY = e.clientY; });
      window.addEventListener('touchmove', e=>{ if(e.touches && e.touches[0]){ mouseX = e.touches[0].clientX; mouseY = e.touches[0].clientY } },{passive:true});

      function draw(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        const g = ctx.createLinearGradient(0,0,0,window.innerHeight);
        g.addColorStop(0, 'rgba(10,14,28,0.6)');
        g.addColorStop(1, 'rgba(2,6,12,0.96)');
        ctx.fillStyle = g; ctx.fillRect(0,0,window.innerWidth,window.innerHeight);

        stars.forEach(s=>{
          const dx = (mouseX - window.innerWidth/2)/window.innerWidth;
          const dy = (mouseY - window.innerHeight/2)/window.innerHeight;
          const px = s.x + dx*20*(s.r);
          const py = s.y + dy*20*(s.r);
          s.alpha += (Math.random()*0.02 - 0.01) * s.twinkle;
          if(s.alpha < 0.15) s.alpha = 0.15;
          if(s.alpha > 1) s.alpha = 1;
          ctx.beginPath();
          ctx.fillStyle = `rgba(255,${Math.max(180 - s.r*40,120)},${Math.max(120 - s.r*20,80)},${s.alpha})`;
          ctx.arc(px, py, s.r, 0, Math.PI*2);
          ctx.fill();
        });

        requestAnimationFrame(draw);
      }

      resize(); draw();
    })();

    // start loading
    loadStories();

    // expose small API for debugging
    window.__OUC = { openNode, chaptersMap, highlightByAuthor };

  })();
  </script>
</body>
</html>
