<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Once Upon a Commit - The Constellation</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/vis-network@9.1.2/dist/dist/vis-network.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/vis-network@9.1.2/dist/dist/vis-network.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /*
        * GLOBAL STYLES & VARIABLES
        */
        :root {
            --bg: #0b1020;
            --panel: #0f1724;
            --muted: #9aa4b2;
            --accent: #ffb86b;
            --star: #ffd7a8;
            --glass: rgba(255, 255, 255, 0.04);
            --border: rgba(255, 255, 255, 0.03);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Light theme overrides */
        [data-theme="light"] {
            --bg: #f7f7f7;
            --panel: #ffffff;
            --muted: #667280;
            --accent: #d47e33;
            --star: #ac6d2c;
            --glass: rgba(0, 0, 0, 0.04);
            --border: rgba(0, 0, 0, 0.05);
            color: #1a202c;
        }
        
        html, body {
            height: 100%;
            margin: 0;
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            -webkit-font-smoothing: antialiased;
            background: var(--bg);
            color: #e6eef8;
            overflow: hidden;
            transition: background var(--transition);
        }

        /*
        * LAYOUT
        */
        #app {
            position: relative;
            height: 100vh;
            width: 100vw;
            display: flex;
        }

        #canvas-wrap {
            position: absolute;
            inset: 0;
            z-index: 0;
            overflow: hidden;
        }

        canvas#starfield {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Panels */
        .panel {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 320px;
            max-width: 80vw;
            z-index: 50;
            display: flex;
            flex-direction: column;
            background: var(--panel);
            box-shadow: 0 6px 30px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(6px);
            border-right: 1px solid var(--border);
            transition: transform var(--transition);
        }

        .panel-left {
            left: 0;
            border-right: 1px solid var(--border);
        }
        
        .panel-right {
            right: 0;
            border-left: 1px solid var(--border);
        }

        .panel-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.25rem;
            color: var(--accent);
        }

        .panel-body {
            overflow: auto;
            padding: 1rem;
            flex: 1;
        }

        /* Network container */
        #network-wrap {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            padding: 0;
            margin: 0;
            z-index: 10;
        }

        #network {
            width: 100%;
            height: 100%;
        }

        /* Reading panel */
        #reading-panel {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: min(720px, 92vw);
            max-width: 100%;
            background: linear-gradient(180deg, rgba(20, 22, 30, 0.96), rgba(8, 10, 15, 0.98));
            z-index: 60;
            transform: translateX(104%);
            transition: transform .38s ease;
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        #reading-panel.open {
            transform: translateX(0);
        }

        #reading-content {
            flex: 1;
            padding: 1.5rem;
            overflow: auto;
        }

        .reading-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .reading-header h2 {
            margin: 0;
            font-family: 'Cormorant Garamond', serif;
            color: var(--accent);
            font-size: 1.5rem;
        }

        .reading-header .author-name {
            font-size: 0.9rem;
            color: var(--muted);
        }

        /*
        * COMPONENTS
        */
        .btn {
            background: var(--glass);
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            color: var(--star);
            cursor: pointer;
            font-weight: 600;
            transition: background var(--transition), color var(--transition);
        }
        .btn:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        /* Features */
        .feature {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, 0.02);
        }
        
        .feature button {
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.06);
            padding: 6px 10px;
            border-radius: 8px;
            color: var(--star);
            cursor: pointer;
        }

        /* Contributors list */
        .contributor-item {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background var(--transition);
        }

        .contributor-item:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .contributor-item img {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .contributor-name {
            font-weight: 600;
            color: #fff;
        }

        .contributor-nodes {
            font-size: 0.8rem;
            color: var(--muted);
        }

        /* Quick Index */
        #quickIndex button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px;
            background: transparent;
            border: none;
            color: #e6eef8;
            border-radius: 4px;
            cursor: pointer;
            transition: background var(--transition);
        }

        #quickIndex button:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .divider {
            border: none;
            border-top: 1px solid var(--border);
            margin: 1rem 0;
        }

        /*
        * MOBILE-SPECIFIC STYLES
        */
        @media (max-width: 768px) {
            .panel {
                width: 100%;
                max-width: 100vw;
                transition: transform 0.4s ease-in-out;
            }

            .panel-left {
                transform: translateX(-100%);
            }
            .panel-left.open {
                transform: translateX(0);
            }
            
            .panel-right {
                transform: translateX(100%);
            }
            .panel-right.open {
                transform: translateX(0);
            }

            .panel-toggle-btn {
                position: absolute;
                top: 1rem;
                left: 1rem;
                z-index: 100;
                display: block;
                background: var(--glass);
                border: 1px solid var(--border);
                color: var(--star);
                padding: 0.5rem 0.75rem;
                border-radius: 8px;
            }

            .right-toggle-btn {
                left: unset;
                right: 1rem;
            }

            .logo {
                display: none; /* Hide logo on mobile to save space */
            }

            #reading-panel {
                width: 100vw;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="canvas-wrap" aria-hidden="true">
            <canvas id="starfield"></canvas>
        </div>

        <div class="panel panel-left" id="leftPanel" role="complementary" aria-label="Navigation panel">
            <div class="panel-header">
                <div class="panel-title">Constellation</div>
                <button class="btn" id="btnDownload" title="Download open chapter as PDF">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                </button>
                <button class="btn" id="btnTheme">🌙</button>
            </div>
            <div class="panel-body">
                <p style="font-size:13px;color:var(--muted);margin-bottom:8px">Tap a star on the map to start reading, or choose a starting point below.</p>
                <div id="quickIndex" style="display:flex;flex-direction:column;gap:8px"></div>
                <div class="divider"></div>
                <p style="font-size:13px;color:var(--muted);margin-bottom:8px">Contributors (tap to highlight their work):</p>
                <div id="contributorsList" style="display:flex;flex-direction:column;gap:8px"></div>
            </div>
        </div>

        <div id="network-wrap">
            <div id="network"></div>
        </div>

        <div id="reading-panel" role="main" aria-modal="true">
            <div class="reading-header">
                <div>
                    <h2 id="readingTitle"></h2>
                    <div class="author-name" id="readingAuthor"></div>
                </div>
                <button class="btn" id="btnClosePanel">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            <div id="reading-content" class="markdown-body"></div>
        </div>
        
        <button class="panel-toggle-btn" id="leftPanelToggle" aria-controls="leftPanel" aria-expanded="false">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
        </button>
    </div>

    <script>
        /*****************************************************************************
        * Frontend app for "The Constellation Book"
        *
        * - Fetches /api/stories
        * - Renders a network with vis-network styled as a star-map
        * - Displays chapters in reading panel (showdown)
        * - Contributors list -> highlight their nodes
        * - PDF export of the open chapter (html2pdf)
        * - Responsive + mobile friendly + no env required
        *****************************************************************************/

        (function () {
            // DOM refs
            const app = document.getElementById('app');
            const networkEl = document.getElementById('network');
            const readingPanel = document.getElementById('reading-panel');
            const readingTitleEl = document.getElementById('readingTitle');
            const readingAuthorEl = document.getElementById('readingAuthor');
            const readingContentEl = document.getElementById('reading-content');
            const quickIndexEl = document.getElementById('quickIndex');
            const contributorsListEl = document.getElementById('contributorsList');
            const btnClosePanel = document.getElementById('btnClosePanel');
            const btnDownload = document.getElementById('btnDownload');
            const btnTheme = document.getElementById('btnTheme');
            const leftPanelEl = document.getElementById('leftPanel');
            const leftPanelToggle = document.getElementById('leftPanelToggle');

            // Data caches
            let chaptersMap = {};
            let contributors = [];
            let currentOpen = null;
            let network = null;
            let nodesDS = null;
            let edgesDS = null;
            let darkTheme = true;

            // Markdown converter
            const converter = new showdown.Converter();

            // Event Listeners
            btnClosePanel.onclick = () => { readingPanel.classList.remove('open'); };
            leftPanelToggle.onclick = () => { leftPanelEl.classList.toggle('open'); };
            btnDownload.onclick = async () => {
                if (!currentOpen) {
                    alert('Open a chapter to download.');
                    return;
                }
                await exportChapterAsPDF(currentOpen);
            };
            btnTheme.onclick = () => {
                darkTheme = !darkTheme;
                if (darkTheme) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    btnTheme.textContent = '🌙';
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                    btnTheme.textContent = '☀️';
                }
                updateNodeColors();
            };

            async function loadStories() {
                try {
                    const res = await fetch('/api/stories');
                    if (!res.ok) throw new Error('Failed to fetch /api/stories');
                    const json = await res.json();
                    
                    json.chapters.forEach(c => {
                        chaptersMap[c.filename] = c;
                    });
                    contributors = json.contributors || [];

                    buildNetwork(json.chapters);
                    renderContributors(contributors);
                    buildQuickIndex(json.chapters);

                } catch (err) {
                    console.error(err);
                    networkEl.innerHTML = `<div style="padding:20px;color:#f8d7da">Failed to load story network. Check server. (${err.message})</div>`;
                }
            }

            function buildNetwork(chapters) {
                const nodes = [];
                const edges = [];
                const degreeCount = {};

                chapters.forEach(c => {
                    const id = c.filename;
                    const title = c.metadata.title || id;
                    const author = c.metadata.author || 'unknown';
                    degreeCount[id] = degreeCount[id] || 0;
                    nodes.push({ id, label: title, title: title, author, value: 10 });

                    if (c.metadata.parent) {
                        edges.push({ from: c.metadata.parent, to: id });
                        degreeCount[c.metadata.parent] = (degreeCount[c.metadata.parent] || 0) + 1;
                        degreeCount[id] = (degreeCount[id] || 0) + 1;
                    }
                });

                nodes.forEach(n => {
                    const deg = degreeCount[n.id] || 0;
                    const size = Math.min(8 + deg * 6, 28);
                    n.size = size;
                    n.shape = 'dot';
                });

                nodesDS = new vis.DataSet(nodes);
                edgesDS = new vis.DataSet(edges);

                const data = { nodes: nodesDS, edges: edgesDS };
                const options = {
                    layout: { hierarchical: { enabled: true, direction: 'UD', sortMethod: 'directed' } },
                    nodes: { font: { color: '#fff' } },
                    edges: { smooth: true, arrows: { to: { enabled: true, scaleFactor: 0.5 } } },
                    interaction: { hover: true, tooltipDelay: 50 },
                    physics: { enabled: false },
                    width: '100%',
                    height: '100%'
                };

                updateNodeColors(); // Initial color update
                network = new vis.Network(networkEl, data, options);

                network.on('click', function (params) {
                    if (params.nodes.length > 0) {
                        openNode(params.nodes[0]);
                        if (window.innerWidth <= 768) {
                            readingPanel.classList.add('open');
                        }
                    }
                });

                network.on('hoverNode', function (params) {
                    if (params.node) {
                        const node = nodesDS.get(params.node);
                        if (node) {
                            networkEl.style.cursor = 'pointer';
                        }
                    } else {
                        networkEl.style.cursor = 'default';
                    }
                });
            }

            function updateNodeColors() {
                if (!nodesDS) return;
                const updated = nodesDS.get().map(n => {
                    const deg = n.value ? Math.min((n.value-8)/6, 28) : 0;
                    const glow = Math.min(60 + deg * 40, 255);
                    const background = `rgba(${255}, ${200}, ${120}, ${0.95})`;
                    const border = '#ffb86b';
                    const highlight = '#fff1e6';
                    
                    return {
                        id: n.id,
                        color: {
                            background: darkTheme ? background : '#ffebc0',
                            border: darkTheme ? border : '#d49b4d',
                            highlight: {
                                background: darkTheme ? highlight : '#fff1e6',
                                border: darkTheme ? border : '#d49b4d'
                            }
                        },
                        font: { color: darkTheme ? '#fff' : '#111' }
                    };
                });
                nodesDS.update(updated);
            }

            function buildQuickIndex(chapters) {
                const tops = chapters.filter(c => !c.metadata.parent || c.metadata.parent.trim() === '').sort((a, b) => a.filename.localeCompare(b.filename));
                quickIndexEl.innerHTML = '';
                tops.slice(0, 20).forEach(t => {
                    const btn = document.createElement('button');
                    btn.textContent = t.metadata.title;
                    btn.onclick = () => { openNode(t.filename); };
                    quickIndexEl.appendChild(btn);
                });
            }

            function renderContributors(contributors) {
                contributorsListEl.innerHTML = '';
                contributors.forEach(c => {
                    const el = document.createElement('div');
                    el.className = 'contributor-item';
                    el.innerHTML = `
                        <img src="${c.avatar_url}" alt="${c.login} avatar">
                        <div>
                            <div class="contributor-name">${c.login}</div>
                            <div class="contributor-nodes">${c.contributedNodes.length} node${c.contributedNodes.length > 1 ? 's' : ''}</div>
                        </div>
                    `;
                    el.onclick = () => highlightByAuthor(c.login);
                    contributorsListEl.appendChild(el);
                });
            }

            function highlightByAuthor(login) {
                const allNodes = nodesDS.get();
                const byAuthor = Object.values(chaptersMap).filter(ch => ch.metadata.author === login).map(ch => ch.filename);
                const updated = allNodes.map(n => {
                    if (byAuthor.includes(n.id)) {
                        return {
                            id: n.id,
                            color: {
                                background: '#ffe8c8',
                                border: '#ffb86b',
                                highlight: { background: '#ffe8c8', border: '#ffb86b' }
                            },
                            size: Math.max((n.value || 10), 18)
                        };
                    } else {
                        return {
                            id: n.id,
                            color: {
                                background: '#1f2a44',
                                border: '#2b3b5a'
                            },
                            size: Math.max((n.value || 10), 8)
                        };
                    }
                });
                nodesDS.update(updated);

                if (byAuthor.length) {
                    network.fit({ nodes: byAuthor, animation: { duration: 600, easingFunction: 'easeInOutQuad' } });
                }
            }

            function openNode(filename) {
                const node = chaptersMap[filename];
                if (!node) return;

                currentOpen = filename;
                readingTitleEl.textContent = node.metadata.title || 'Untitled';
                readingAuthorEl.textContent = `by ${node.metadata.author || 'unknown'}`;
                readingContentEl.innerHTML = converter.makeHtml(node.content);
                readingPanel.classList.add('open');
            }

            async function exportChapterAsPDF(filename) {
                const node = chaptersMap[filename];
                if (!node) return;
                
                const pdfWrap = document.createElement('div');
                pdfWrap.style.padding = '36px';
                pdfWrap.style.background = '#fff';
                pdfWrap.style.color = '#111';
                pdfWrap.style.fontFamily = 'serif';
                
                pdfWrap.innerHTML = `
                    <h1 style="font-family: 'Cormorant Garamond', serif; font-size: 28px; color: #111; margin-bottom: 6px;">
                        ${escapeHtml(node.metadata.title || 'Untitled')}
                    </h1>
                    <div style="font-size: 13px; color: #555; margin-bottom: 16px;">
                        by ${escapeHtml(node.metadata.author || 'unknown')}
                    </div>
                    <div>${converter.makeHtml(node.content)}</div>
                `;
                
                document.body.appendChild(pdfWrap);
                await html2pdf().from(pdfWrap).save(`${sanitizeFilename(node.metadata.title)}.pdf`);
                document.body.removeChild(pdfWrap);
            }

            function escapeHtml(s) {
                return (s || '').replace(/[&<>"']/g, c => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[c]));
            }

            function sanitizeFilename(s) {
                return (s || 'chapter').replace(/[^a-z0-9_\- ]/gi, '_').trim();
            }

            // Starfield background
            const canvas = document.getElementById('starfield');
            const ctx = canvas.getContext('2d');
            const stars = [];

            function resize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }

            function initStars() {
                stars.length = 0;
                const count = Math.floor((window.innerWidth + window.innerHeight) / 8);
                for (let i = 0; i < count; i++) {
                    stars.push({
                        x: Math.random() * window.innerWidth,
                        y: Math.random() * window.innerHeight,
                        r: (Math.random() * 1.8) + 0.4,
                        alpha: Math.random() * 0.9 + 0.1,
                        twinkle: Math.random() * 0.02 + 0.005,
                        vx: (Math.random() - 0.5) * 0.02,
                        vy: (Math.random() - 0.5) * 0.02
                    });
                }
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const g = ctx.createLinearGradient(0, 0, 0, window.innerHeight);
                g.addColorStop(0, 'rgba(11, 16, 32, 0.4)');
                g.addColorStop(1, 'rgba(11, 16, 32, 0)');
                ctx.fillStyle = g;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                stars.forEach(s => {
                    ctx.beginPath();
                    ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 255, 255, ${s.alpha})`;
                    ctx.fill();
                    
                    s.alpha += s.twinkle;
                    if (s.alpha > 1 || s.alpha < 0.1) s.twinkle *= -1;
                    
                    s.x += s.vx;
                    s.y += s.vy;
                    if (s.x > canvas.width || s.x < 0) s.vx *= -1;
                    if (s.y > canvas.height || s.y < 0) s.vy *= -1;
                });
                requestAnimationFrame(draw);
            }

            window.addEventListener('resize', () => { resize(); initStars(); });
            
            resize();
            initStars();
            draw();
            loadStories();

            // expose for debugging
            window.__OUC = { openNode, chaptersMap };
        })();
    </script>
</body>
</html>