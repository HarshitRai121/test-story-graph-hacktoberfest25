<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Once Upon a Commit ‚Äî The Constellation</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

  <!-- Vis Network -->
  <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/vis-network/dist/vis-network.min.js"></script>

  <!-- Showdown (markdown) -->
  <script src="https://cdn.jsdelivr.net/npm/showdown@1.9.1/dist/showdown.min.js"></script>

  <!-- html2pdf for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <meta name="theme-color" content="#0b1020">

  <style>
    :root{
      --bg:#0b1020;
      --panel:rgba(15,23,36,0.95);
      --muted:#9aa4b2;
      --accent:#ffb86b;
      --star:#ffd7a8;
      --glass:rgba(255,255,255,0.03);
      --card-radius:14px;
      --nav-height:64px;
    }
    html,body{margin:0;height:100%;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:var(--bg);color:#e6eef8;overflow:hidden}
    *{box-sizing:border-box}
    #app{height:100%;width:100%;position:relative;overflow:hidden}

    /* starfield */
    #canvas-wrap{position:fixed;inset:0;z-index:0}
    canvas#starfield{width:100%;height:100%;display:block}

    /* main graph container */
    #network-wrap{position:fixed;inset:0;z-index:10}
    #network{width:100%;height:100%}

    /* topbar */
    .topbar{position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:70;display:flex;align-items:center;gap:10px;background:rgba(0,0,0,0.35);padding:6px 14px;border-radius:999px;backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.05)}
    .logo{font-family:'Cormorant Garamond',serif;color:var(--accent);font-size:16px;letter-spacing:0.4px}
    .top-btn{background:none;border:1px solid rgba(255,255,255,0.08);color:var(--star);font-size:13px;padding:4px 10px;border-radius:8px;cursor:pointer}
    .top-btn:hover{background:rgba(255,255,255,0.08)}

    /* overlay panels */
    .panel{position:fixed;top:0;bottom:0;width:320px;max-width:80vw;background:var(--panel);box-shadow:0 0 30px rgba(0,0,0,0.6);backdrop-filter:blur(8px);z-index:80;transform:translateX(-105%);transition:transform .3s ease}
    .panel.open{transform:translateX(0)}
    .left-panel{left:0}
    .right-panel{right:0;transform:translateX(105%)}
    .panel-header{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:space-between}
    .panel-title{font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--accent)}
    .panel-body{overflow:auto;padding:12px;height:100%}

    /* reading overlay */
    #reading-panel{position:fixed;right:0;top:0;bottom:0;width:min(720px,92vw);background:var(--panel);box-shadow:-8px 0 40px rgba(0,0,0,0.7);z-index:90;transform:translateX(105%);transition:transform .35s ease}
    #reading-panel.open{transform:translateX(0)}
    .reading-header{padding:16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,0.08)}
    .reading-title{font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--accent)}
    .reading-meta{color:var(--muted);font-size:13px}
    .reading-body{overflow:auto;padding:16px;font-size:15px;line-height:1.6}
    .close-reading{background:none;border:1px solid rgba(255,255,255,0.1);padding:6px 12px;border-radius:8px;color:var(--star);cursor:pointer}

    /* legend */
    .legend{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);z-index:60;background:rgba(0,0,0,0.35);padding:6px 12px;border-radius:999px;font-size:13px;color:var(--muted);border:1px solid rgba(255,255,255,0.05)}

    /* mobile bottom nav */
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;height:var(--nav-height);background:rgba(0,0,0,0.8);display:flex;z-index:95;border-top:1px solid rgba(255,255,255,0.1)}
    .nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--muted);font-size:12px;cursor:pointer}
    .nav-btn.active{color:var(--accent)}

    @media(min-width:900px){.bottom-nav{display:none}}
    @media(max-width:899px){.topbar .top-btn{display:none}}
  </style>
</head>
<body>
  <div id="app">
    <!-- starfield -->
    <div id="canvas-wrap"><canvas id="starfield"></canvas></div>

    <!-- graph -->
    <div id="network-wrap"><div id="network"></div></div>

    <!-- topbar with toggles -->
    <div class="topbar">
      <div class="logo">Once Upon a Commit</div>
      <button class="top-btn" id="btnContrib">üë•</button>
      <button class="top-btn" id="btnFeatures">‚öôÔ∏è</button>
    </div>

    <!-- contributors panel -->
    <aside class="panel left-panel" id="leftPanel">
      <div class="panel-header"><div class="panel-title">Contributors</div><button class="close-reading" onclick="togglePanel('leftPanel',false)">Close</button></div>
      <div class="panel-body" id="contributorsList"></div>
    </aside>

    <!-- features panel -->
    <aside class="panel right-panel" id="rightPanel">
      <div class="panel-header"><div class="panel-title">Features</div><button class="close-reading" onclick="togglePanel('rightPanel',false)">Close</button></div>
      <div class="panel-body">
        <button id="btnDownload">Download PDF</button>
        <button id="btnTheme">üåô Theme</button>
      </div>
    </aside>

    <!-- reading panel -->
    <aside id="reading-panel">
      <div class="reading-header">
        <div>
          <div class="reading-title" id="readingTitle">Chapter</div>
          <div class="reading-meta" id="readingMeta">by unknown</div>
        </div>
        <button class="close-reading" id="closeReading">Close</button>
      </div>
      <div class="reading-body" id="readingBody"></div>
    </aside>

    <!-- legend -->
    <div class="legend">‚≠ê Tap star to read ¬∑ Panels open only when clicked</div>

    <!-- bottom nav (mobile) -->
    <div class="bottom-nav">
      <div class="nav-btn" id="navContrib">üë•<div>People</div></div>
      <div class="nav-btn" id="navFeatures">‚öôÔ∏è<div>Features</div></div>
      <div class="nav-btn" id="navReading">üìñ<div>Read</div></div>
    </div>
  </div>

  <script>
    // helper: toggle panels
    function togglePanel(id){
      const el=document.getElementById(id);
      if(!el) return;
      el.classList.toggle('open');
    }

    function closeAllPanels(){
      document.querySelectorAll('.panel, #reading-panel').forEach(p=>p.classList.remove('open'));
    }

    // desktop topbar toggles
    document.getElementById('btnContrib').onclick=()=>togglePanel('leftPanel');
    document.getElementById('btnFeatures').onclick=()=>togglePanel('rightPanel');
    document.getElementById('closeReading').onclick=()=>togglePanel('reading-panel');

    // mobile nav toggles
    document.getElementById('navContrib').onclick=()=>togglePanel('leftPanel');
    document.getElementById('navFeatures').onclick=()=>togglePanel('rightPanel');
    document.getElementById('navReading').onclick=()=>togglePanel('reading-panel');

    // close if click outside
    document.addEventListener('click',e=>{
      const panels=document.querySelectorAll('.panel, #reading-panel');
      const isPanelClick=[...panels].some(p=>p.contains(e.target));
      const isButtonClick=e.target.closest('.top-btn,.nav-btn,.close-reading');
      if(!isPanelClick && !isButtonClick){
        closeAllPanels();
      }
    });

    // -------- Starfield --------
    const canvas=document.getElementById("starfield"),ctx=canvas.getContext("2d");
    function resizeCanvas(){canvas.width=window.innerWidth;canvas.height=window.innerHeight}
    window.addEventListener("resize",resizeCanvas);resizeCanvas();
    const stars=Array.from({length:300},()=>({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:Math.random()*1.5+0.5,d:Math.random()*0.5+0.2}));
    function animateStars(){ctx.clearRect(0,0,canvas.width,canvas.height);for(const s of stars){ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,2*Math.PI);ctx.fillStyle="white";ctx.fill();s.y+=s.d;if(s.y>canvas.height){s.y=0;s.x=Math.random()*canvas.width}}requestAnimationFrame(animateStars)}animateStars();

    // -------- Graph --------
    const container=document.getElementById('network');
    const nodes=new vis.DataSet([]);
    const edges=new vis.DataSet([]);
    const network=new vis.Network(container,{nodes,edges},{physics:{stabilization:true},interaction:{hover:true}});

    // Load story data
    async function loadStories(){
      try{
        const res=await fetch('/api/stories');
        const data=await res.json();
        data.nodes.forEach(n=>nodes.add(n));
        data.edges.forEach(e=>edges.add(e));
        renderContributors(data.contributors||[]);
      }catch(e){console.error("Error loading stories",e)}
    }

    function renderContributors(list){
      const c=document.getElementById('contributorsList');
      c.innerHTML='';
      list.forEach(p=>{
        const div=document.createElement('div');
        div.textContent=p;
        c.appendChild(div);
      });
    }

    // Click on node => open reading
    network.on("click",params=>{
      if(params.nodes.length){
        const id=params.nodes[0];
        openReading(id);
      }
    });

    // -------- Reading --------
    const converter=new showdown.Converter();
    async function openReading(id){
      try{
        const res=await fetch(`/api/chapter/${id}`);
        const data=await res.json();
        document.getElementById('readingTitle').textContent=data.title||"Untitled";
        document.getElementById('readingMeta').textContent="by "+(data.author||"unknown");
        document.getElementById('readingBody').innerHTML=converter.makeHtml(data.content||"");
        document.getElementById('reading-panel').classList.add('open');
      }catch(e){console.error("Error loading chapter",e)}
    }

    // -------- Features --------
    document.getElementById('btnDownload').onclick=()=>{
      const element=document.getElementById('readingBody');
      html2pdf().from(element).save('chapter.pdf');
    };
    document.getElementById('btnTheme').onclick=()=>{
      document.body.classList.toggle('light');
    };

    // Init
    loadStories();
  </script>
</body>
</html>
